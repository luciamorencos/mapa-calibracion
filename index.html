
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mapa Calibraci√≥n Interdental ‚Äì Avenida 35 (V20)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial;background:#f0f0f0;text-align:center;}

#header{
 position:sticky;top:0;z-index:50;
 background:#fff;padding:8px 10px;
 border-bottom:2px solid #ddd;
 display:flex;justify-content:center;align-items:center;gap:10px;
}

#header input{
 padding:6px 8px;font-size:14px;width:140px;
 border:1px solid #999;border-radius:4px;
}

#container{position:relative;display:inline-block;margin-top:6px;}
#bg{display:block;max-width:100%;height:auto;}
canvas{position:absolute;top:0;left:0;touch-action:none;}

#toolbar{
 position:absolute;top:45%;left:50%;transform:translate(-50%,-50%);
 background:rgba(255,255,255,.95);
 padding:8px 10px;border:1px solid #aaa;
 border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.2);
 z-index:20;cursor:move;
}

button{
 margin:2px;padding:4px 7px;border:1px solid #555;
 cursor:pointer;font-size:12px;font-weight:bold;border-radius:4px;
}

.color-btn{color:white;}

#previewBox{
 display:none;
 position:fixed;
 top:0;left:0;width:100%;height:100%;
 background:rgba(0,0,0,0.8);
 z-index:200;
 justify-content:center;
 align-items:center;
 flex-direction:column;
}

#previewBox img{
 max-width:90%;
 max-height:80%;
 border:4px solid white;
 background:white;
}

#previewBox button{
 margin-top:10px;
 padding:8px 14px;
 font-size:14px;
}
</style>
</head>

<body>

<div id="header">
 <strong>ID paciente:</strong>
 <input type="number" id="patientId" placeholder="Ej. 12345">
</div>

<div id="container">

<div id="toolbar">

<b>PRIME</b><br>
<button class="color-btn" style="background:#009FE3" onclick="selectColor('#009FE3','prime')">06</button>
<button class="color-btn" style="background:#E30613" onclick="selectColor('#E30613','prime')">07</button>
<button class="color-btn" style="background:#E6007E" onclick="selectColor('#E6007E','prime')">08</button>
<button class="color-btn" style="background:#FFD500;color:#000" onclick="selectColor('#FFD500','prime')">09</button>
<button class="color-btn" style="background:#7CB518" onclick="selectColor('#7CB518','prime')">011</button>

<br><br>

<b>PERIO</b><br>
<button class="color-btn" style="background:#E30613" onclick="selectColor('#E30613','perio')">405</button>
<button class="color-btn" style="background:#E83E8C" onclick="selectColor('#E83E8C','perio')">406</button>
<button class="color-btn" style="background:#6F42C1" onclick="selectColor('#6F42C1','perio')">408</button>
<button class="color-btn" style="background:#0B3C5D" onclick="selectColor('#0B3C5D','perio')">410</button>

<br><br>

<button onclick="selectFree()">X</button>
<button onclick="selectEraser()">üßΩ</button>
<button onclick="undo()">‚Ü©</button>
<button onclick="saveImage()">üíæ</button>

</div>

<img id="bg" src="mapa_bg.png">
<canvas id="canvas"></canvas>

</div>

<div id="previewBox">
 <img id="previewImg">
 <button onclick="downloadImage()">‚¨áÔ∏è Descargar imagen</button>
 <button onclick="closePreview()">Cerrar</button>
</div>

<script>
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const bg=document.getElementById("bg");
const toolbar=document.getElementById("toolbar");

let history=[];
let color="#000";
let mode="arrow";
let type="prime";
let start=null;
let drawing=false;
let lastImageURL="";

bg.onload=()=>{
 canvas.width=bg.clientWidth;
 canvas.height=bg.clientHeight;
 saveState();
};

function saveState(){
 history.push(ctx.getImageData(0,0,canvas.width,canvas.height));
}

function undo(){
 if(history.length>1){
  history.pop();
  ctx.putImageData(history[history.length-1],0,0);
 }
}

function selectColor(c,t){ color=c; type=t; mode="arrow"; }
function selectFree(){ mode="free"; }
function selectEraser(){ mode="erase"; }

function hasInk(x,y){
 const d=ctx.getImageData(x-2,y-2,4,4).data;
 for(let i=0;i<d.length;i+=4){
  if(d[i+3]>40) return true;
 }
 return false;
}

function clean(x,y){
 ctx.clearRect(x-20,y-20,40,40);
}

function drawArrow(x1,y1,x2,y2){

 saveState();

 const ang=Math.atan2(y2-y1,x2-x1);
 const len=50, head=14;

 const ex=x1+len*Math.cos(ang);
 const ey=y1+len*Math.sin(ang);

 ctx.strokeStyle=color;
 ctx.fillStyle=color;
 ctx.lineWidth=6;
 ctx.lineCap="round";

 ctx.beginPath();
 ctx.moveTo(x1,y1);
 ctx.lineTo(ex,ey);
 ctx.stroke();

 ctx.beginPath();
 ctx.moveTo(ex,ey);
 ctx.lineTo(ex-head*Math.cos(ang-Math.PI/6), ey-head*Math.sin(ang-Math.PI/6));
 ctx.lineTo(ex-head*Math.cos(ang+Math.PI/6), ey-head*Math.sin(ang+Math.PI/6));
 ctx.closePath();
 ctx.fill();

 if(type==="perio"){
  ctx.font="bold 14px Arial";
  ctx.fillStyle=color;
  const px=x1-12*Math.cos(ang);
  const py=y1-12*Math.sin(ang);
  ctx.fillText("P",px,py);
 }
}

// Mouse
canvas.addEventListener("mousedown",e=>{
 const x=e.offsetX,y=e.offsetY;

 if(mode==="arrow"){
  start={x,y};
 }
 else if(mode==="free"){
  drawing=true;
  saveState();
  ctx.beginPath();
  ctx.moveTo(x,y);
 }
 else if(mode==="erase"){
  if(hasInk(x,y)){
   saveState(); clean(x,y);
  }
 }
});

canvas.addEventListener("mousemove",e=>{
 if(drawing && mode==="free"){
  ctx.lineWidth=4;
  ctx.strokeStyle="black";
  ctx.lineTo(e.offsetX,e.offsetY);
  ctx.stroke();
 }
});

canvas.addEventListener("mouseup",e=>{

 if(mode==="arrow" && start){
  drawArrow(start.x,start.y,e.offsetX,e.offsetY);
  start=null;
 }

 drawing=false;
});

canvas.addEventListener("mouseout",()=>drawing=false);

// Drag toolbar
let drag=false,dx=0,dy=0;

toolbar.addEventListener("mousedown",e=>{
 drag=true;
 dx=e.clientX-toolbar.offsetLeft;
 dy=e.clientY-toolbar.offsetTop;
});

document.addEventListener("mousemove",e=>{
 if(drag){
  toolbar.style.left=(e.clientX-dx)+"px";
  toolbar.style.top=(e.clientY-dy)+"px";
  toolbar.style.transform="none";
 }
});

document.addEventListener("mouseup",()=>drag=false);

// SAVE with preview
function saveImage(){

 const temp=document.createElement("canvas");
 temp.width=canvas.width;
 temp.height=canvas.height;

 const t=temp.getContext("2d");

 t.drawImage(bg,0,0,canvas.width,canvas.height);
 t.drawImage(canvas,0,0);

 const pid=document.getElementById("patientId").value;

 if(pid){
  t.font="bold 16px Arial";
  t.fillStyle="#000";
  t.fillText("ID: "+pid,10,22);
 }

 lastImageURL=temp.toDataURL("image/png");

 document.getElementById("previewImg").src=lastImageURL;
 document.getElementById("previewBox").style.display="flex";
}

function closePreview(){
 document.getElementById("previewBox").style.display="none";
}

function downloadImage(){

 if(!lastImageURL) return;

 const pid=document.getElementById("patientId").value;
 const name="calibracion_"+(pid||"paciente")+".png";

 const a=document.createElement("a");
 a.href=lastImageURL;
 a.download=name;
 document.body.appendChild(a);
 a.click();
 document.body.removeChild(a);
}
</script>

</body>
</html>
