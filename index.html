<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapa CalibraciÃ³n Interdental</title>

<style>
body{
    margin:0;
    font-family:Arial, sans-serif;
    background:#f0f0f0;
    text-align:center;
}

#header{
    background:white;
    padding:10px;
    position:sticky;
    top:0;
    z-index:100;
    border-bottom:1px solid #ddd;
}

#container{
    position:relative;
    display:inline-block;
    margin-top:10px;
}

#bg{
    max-width:100%;
    height:auto;
    display:block;
}

canvas{
    position:absolute;
    top:0;
    left:0;
    touch-action:none;
}

#toolbar{
    position:absolute;
    top:45%;
    left:50%;
    transform:translate(-50%,-50%);
    background:rgba(255,255,255,0.95);
    padding:10px;
    border-radius:10px;
    box-shadow:0 5px 15px rgba(0,0,0,0.2);
    display:flex;
    flex-direction:column;
    gap:8px;
    z-index:200;
}

.row{
    display:flex;
    gap:6px;
    justify-content:center;
    flex-wrap:wrap;
}

button{
    border:none;
    padding:6px 10px;
    border-radius:6px;
    font-weight:bold;
    cursor:pointer;
}
</style>
</head>

<body>

<div id="header">
    <strong>ID paciente:</strong>
    <input type="text" placeholder="Ej. 12345">
</div>

<div id="container">
    <img id="bg" src="mapa_bg.png">
    <canvas id="canvas"></canvas>

    <div id="toolbar">

        <div><strong>PRIME</strong></div>
        <div class="row">
            <button style="background:#1E90FF" onclick="setColor('#1E90FF')">06</button>
            <button style="background:#FF0000" onclick="setColor('#FF0000')">07</button>
            <button style="background:#FF1493" onclick="setColor('#FF1493')">08</button>
            <button style="background:#FFD700" onclick="setColor('#FFD700')">09</button>
            <button style="background:#32CD32" onclick="setColor('#32CD32')">011</button>
        </div>

        <div><strong>PERIO</strong></div>
        <div class="row">
            <button style="background:#B22222" onclick="setColor('#B22222','P')">405</button>
            <button style="background:#FF69B4" onclick="setColor('#FF69B4','P')">406</button>
            <button style="background:#8A2BE2" onclick="setColor('#8A2BE2','P')">408</button>
            <button style="background:#003366" onclick="setColor('#003366','P')">410</button>
        </div>

        <div class="row">
            <button onclick="setMode('erase')">X</button>
            <button onclick="undo()">â†©</button>
            <button onclick="saveImage()">ðŸ’¾</button>
        </div>

    </div>
</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const bg = document.getElementById("bg");

let drawing = false;
let startX, startY;
let color = "#000";
let perio = "";
let mode = "draw";
let history = [];

bg.onload = () => {
    canvas.width = bg.clientWidth;
    canvas.height = bg.clientHeight;
};

function setColor(c,p=""){
    color = c;
    perio = p;
    mode = "draw";
}

function setMode(m){
    mode = m;
}

function getPos(e){
    const rect = canvas.getBoundingClientRect();
    if(e.touches){
        return {
            x: e.touches[0].clientX - rect.left,
            y: e.touches[0].clientY - rect.top
        };
    } else {
        return {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
        };
    }
}

function startDraw(e){
    e.preventDefault();
    const pos = getPos(e);
    startX = pos.x;
    startY = pos.y;
    drawing = true;
}

function endDraw(e){
    if(!drawing) return;
    drawing = false;

    const pos = getPos(e.changedTouches ? e.changedTouches[0] : e);

    history.push(ctx.getImageData(0,0,canvas.width,canvas.height));

    if(mode==="erase"){
        ctx.clearRect(pos.x-12,pos.y-12,24,24);
        return;
    }

    ctx.strokeStyle = color;
    ctx.lineWidth = 5;
    ctx.beginPath();
    ctx.moveTo(startX,startY);
    ctx.lineTo(pos.x,pos.y);
    ctx.stroke();

    const angle = Math.atan2(pos.y-startY,pos.x-startX);
    const headlen = 15;
    ctx.beginPath();
    ctx.moveTo(pos.x,pos.y);
    ctx.lineTo(pos.x-headlen*Math.cos(angle-Math.PI/6),
               pos.y-headlen*Math.sin(angle-Math.PI/6));
    ctx.lineTo(pos.x-headlen*Math.cos(angle+Math.PI/6),
               pos.y-headlen*Math.sin(angle+Math.PI/6));
    ctx.lineTo(pos.x,pos.y);
    ctx.fillStyle=color;
    ctx.fill();

    if(perio==="P"){
        ctx.fillStyle=color;
        ctx.font="16px Arial";
        ctx.fillText("P",startX-10,startY-10);
    }
}

function undo(){
    if(history.length>0){
        ctx.putImageData(history.pop(),0,0);
    }
}

function saveImage(){
    const link=document.createElement("a");
    link.download="mapa_calibracion.png";
    link.href=canvas.toDataURL();
    link.click();
}

canvas.addEventListener("mousedown",startDraw);
canvas.addEventListener("mouseup",endDraw);

canvas.addEventListener("touchstart",startDraw);
canvas.addEventListener("touchend",endDraw);
</script>

</body>
</html>
